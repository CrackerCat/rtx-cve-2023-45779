#!/bin/bash
set -euo pipefail

MYPATH=$(dirname "$0")
source "$MYPATH/common.sh"

if test "$#" -lt 1 ; then
	echo "Usage: $(basename "$0") module.apex ..." >&2
	exit 1
fi

get_apk_key() {
	apksigner verify --print-certs "$1" \
		| sed -nE 's/^Signer #1 certificate SHA-256 digest: ([0-9a-f]{64})$/\1/p'
}

get_avb_key() {
	unzip -p "$1" apex_pubkey | sha256sum | cut -d' ' -f1
}

for APEX in "$@" ; do
	APK_MATCH=' '
	AVB_MATCH=' '

	grep -Fxq "$(get_apk_key "$APEX")" "$PUBLIC_APK_KEYS" && APK_MATCH='X'
	grep -Fxq "$(get_avb_key "$APEX")" "$PUBLIC_AVB_KEYS" && AVB_MATCH='X'

	echo "$APK_MATCH$AVB_MATCH $APEX"
done
