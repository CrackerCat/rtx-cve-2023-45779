#!/bin/bash
set -euo pipefail

MYPATH="$(dirname "$0")"
source "$MYPATH/envsetup.sh"

if test "$#" -ne 4 ; then
  echo "Usage: $0 payload_privkey payload_pubkey apk_privkey apk_cert" >&2
  echo "  payload_privkey: .pem" >&2
  echo "  payload_pubkey: .avbpubkey" >&2
  echo "  apk_privkey: .pk8" >&2
  echo "  apk_cert: .x509.pem" >&2
  exit 1
fi

apexer -v \
  --apexer_tool_path "$AOSP/out/host/linux-x86/bin" \
  --build_info apex_build_info.pb \
  --canned_fs_config canned_fs_config \
  --android_jar_path "$AOSP/prebuilts/sdk/$API_VER/public/android.jar" \
  --key "$1" \
  --pubkey "$2" \
  payload forged-unaligned.apex

zipalign 4096 forged-unaligned.apex forged.apex
apksigner sign --key "$3" --cert "$4" forged.apex
